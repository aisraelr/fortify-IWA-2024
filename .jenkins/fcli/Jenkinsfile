pipeline {
    agent any
    environment {
        FOD_SESSION = 'jenkins'
    }
    stages {

        stage('Build') {
            steps {
                echo "üî® Building the application..."
                bat 'mvn clean package -DskipTests'
            }
        }

        stage('FoD SAST Scan') {
            steps {
                echo "üõ°Ô∏è Starting FoD SAST scan..."
                
                // Ejecuta el scan y guarda toda la salida
                bat """
                fcli.exe fod sast-scan start ^
                    --rel 1388854 ^
                    --file "target\\iwa.jar" ^
                    --fod-session %FOD_SESSION% ^
                    --store curScan ^
                    --output json 1>curScan_raw.txt 2>curScan.err
                """

                // Extrae s√≥lo el JSON usando PowerShell
                powershell """
                \$jsonLine = Select-String -Path curScan_raw.txt -Pattern '{.*}' | ForEach-Object { \$_ -replace '^.*?({.*}).*$', '\$1' }
                \$jsonLine | Set-Content -Encoding UTF8 curScan.json
                """

                // Lee el JSON limpio en Groovy
                script {
                    def curScan = readJSON file: 'curScan.json'
                    echo "Scan started successfully! Scan ID: ${curScan.scanId}"
                }
            }
        }

        stage('Wait for Scan Completion') {
            steps {
                echo "‚è≥ Waiting for scan completion..."

                script {
                    // Usa la variable de store directamente
                    bat """
                    fcli.exe fod sast-scan wait-for ::curScan:: ^
                        --fod-session %FOD_SESSION% ^
                        --timeout 1h
                    """
                }
            }
        }

        stage('Get Scan Results') {
            steps {
                echo "üìä Retrieving scan results..."

                script {
                    bat """
                    fcli.exe fod sast-scan get-results ^
                        ::curScan:: ^
                        --fod-session %FOD_SESSION% ^
                        --output json ^
                        --to-file scan_results.json
                    """

                    def results = readJSON file: 'scan_results.json'
                    echo "Scan finished. Analysis status: ${results.analysisStatusType}"
                }
            }
        }
    }

    post {
        always {
            echo "üßπ Cleaning up..."
        }
        success {
            echo "‚úÖ Pipeline finished successfully!"
        }
        failure {
            echo "‚ùå Pipeline failed!"
        }
    }
}

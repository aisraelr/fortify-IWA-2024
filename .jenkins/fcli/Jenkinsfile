#!/usr/bin/env groovy

pipeline {
    agent any

    parameters {
        string(name: 'FOD_RELEASE_ID', defaultValue: '', description: 'Fortify on Demand Release ID')
        string(name: 'BRANCH_NAME', defaultValue: 'main', description: 'Branch to build')
        string(name: 'MVN_GOALS', defaultValue: 'clean package -DskipTests', description: 'Maven build goals')
    }

    environment {
        FCLI_HOME = 'C:\\fcli'
        PATH = "${env.PATH};${env.FCLI_HOME}"
        FCLI_VERSION = 'v3.8.1'   // 🔧 cámbialo fácilmente cuando salga nueva versión
    }

    stages {
        stage('Setup FCLI') {
            steps {
                script {
                    if (!fileExists("${env.FCLI_HOME}\\fcli.exe")) {
                        echo "⚙️ fcli not found. Downloading..."
                        bat """
                            mkdir ${env.FCLI_HOME} 2>nul
                            powershell -Command "Invoke-WebRequest -Uri https://github.com/fortify/fcli/releases/download/${env.FCLI_VERSION}/fcli-windows.zip -OutFile ${env.FCLI_HOME}\\fcli.zip"
                            powershell -Command "Expand-Archive -Force ${env.FCLI_HOME}\\fcli.zip ${env.FCLI_HOME}"
                            del ${env.FCLI_HOME}\\fcli.zip
                        """
                    } else {
                        echo "✅ fcli already installed at ${env.FCLI_HOME}"
                    }
                }
            }
        }

        stage('Checkout') {
            steps {
                echo "📥 Checking out branch: ${params.BRANCH_NAME}"
                checkout([$class: 'GitSCM',
                          branches: [[name: "*/${params.BRANCH_NAME}"]],
                          userRemoteConfigs: [[url: scm.userRemoteConfigs[0].url]]])
            }
        }

        stage('Build') {
            steps {
                echo "⚒️ Running Maven build with goals: ${params.MVN_GOALS}"
                bat "mvn ${params.MVN_GOALS}"
            }
        }

        stage('FoD SAST Scan') {
            steps {
                echo "🚀 Starting FoD SAST scan..."
                bat """
                    fcli.exe fod sast-scan start ^
                        --rel ${params.FOD_RELEASE_ID} ^
                        --file "target\\iwa.jar" ^
                        --fod-session jenkins ^
                        --store curScan ^
                        --output json > curScan.json 2>curScan.err
                """
                script {
                    def jsonContent = readFile('curScan.json').trim()
                    if (!jsonContent.startsWith("{")) {
                        echo "❌ fcli did not return JSON. Error output:"
                        echo readFile('curScan.err')
                        error("FoD SAST scan start failed. See above error.")
                    }
                    def curScan = readJSON text: jsonContent
                    env.SCAN_ID = curScan.id.toString()
                    echo "✅ Captured Scan ID: ${env.SCAN_ID}"
                }
            }
        }


        stage('Wait for Scan Completion') {
            steps {
                echo "⏳ Waiting for scan completion..."
                bat """
                    fcli.exe fod sast-scan wait-for --scan ${env.SCAN_ID} --fod-session jenkins
                """
            }
        }

        stage('Get Scan Results') {
            steps {
                echo "📥 Fetching scan results..."
                bat """
                    fcli.exe fod sast-scan get ${env.SCAN_ID} --fod-session jenkins --output json > scanResult.json
                """
                script {
                    def scanResult = readJSON file: 'scanResult.json'
                    echo "📊 Scan Result: ${scanResult}"
                }
            }
        }
    }

    post {
        always {
            echo "🧹 Cleaning up..."
        }
    }
}
